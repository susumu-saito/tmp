{"Signature":"1sWTnHJK+mF7hZudINteTA==","CustomerID":null,"QueryID":0,"QueryName":"test","Description":"","CreationDate":"2019-12-19T07:49:34Z","PrefixedQueryName":"0.test","Definition":"QueryDef(\n\tParameters=[\n\t\tCustomerID->Integer(Required=true),\n\t\tControllerID->Integer(Required=true),\n\t\tFrom->Date(Required=true, Period=\"Day\", EndOfPeriod=false),\n\t\tTo->Date(Required=true,Period=\"Day\",EndOfPeriod=true),\n\t\tFID1->Integer(_Match=\"FieldID\"),\n\t\tFID2->Integer(Required=false,_Match=\"FieldID\"),\n\t\tIncludeBeginEnd->Boolean(DESCription=\"With rows for report begin/end\",Required=true,Default=true)\n\t],\n\tInlinePars=PARS(CustomerID,ControllerID,FID1,FID2,IncludeBeginEnd),\n\tQuery=def(pars)=>$\"\n\n\tWITH h AS (\n\t\tSELECT\n\t\t\tDATEADD(hh, 9, Time) AS T,\n\t\t\tFieldID ,\n\t\t\tFieldValue\n\t\tFROM EventsHistory_{pars.ControllerID}\n\t\tWHERE FieldID IN (@FID1,@FID2)\n\t\t\tAND FieldValue IS NOT NULL\n\t),\n\n\th2 AS (\n\t\tSELECT @CustomerID AS CustomerID,\n\t\t\tT,\n\t\t\tDATEADD(DAY,DATEDIFF(DAY,0, getdate()),0) as T1,\n\t\t\tDATEADD(DAY,DATEDIFF(DAY,0, getdate()),1) as T2,\n\t\t\t(CASE WHEN FieldID=@FID1 THEN FieldValue END) AS [F1],\n\t\t\t(CASE WHEN FieldID=@FID2 THEN FieldValue END) AS [F2]\n\t\t FROM h\n\t),\n\n\th3 AS (\n\t\tSELECT\n\t\t\tCustomerID,\n\t\t\tT,\n\t\t\tMAX(F1) AS F1,\n\t\t\tMAX(F2) AS F2,\n                                    ROUND(MAX(F1) / (MAX(F2)/1000),2,1) as F3\n\n\t\tFROM h2\n\t\twhere T between T1 and T2\n\t\tGROUP BY CustomerID,T\n\t),\n\th4 AS (\n\t\tSELECT\n\t\t\t*\n\n\t\tFROM h3\n\t\tWHERE F3 IS NOT NULL\n\t)\n\t , starth as (\n\tselect top(1) @CustomerID as CustomerID,@From as [Time],\n\t(select top 1 FieldValue from h where T<=@From and FieldID=@FID1 order by T desc)  as F1,\n\t(select top 1 FieldValue from h where T<=@From and FieldID=@FID2 order by T desc)  as F2,\n\t(select top 1 FieldValue from h where T<=@From order by T desc)  as F3\n\twhere @IncludeBeginEnd=1\n )\n\t , endh as (\n\tselect top(1) @CustomerID as CustomerID,@To as [Time],\n\t(select top 1 FieldValue from h where T<=@To and FieldID=@FID1 order by T desc)  as F1,\n\t(select top 1 FieldValue from h where T<=@To and FieldID=@FID2 order by T desc)  as F2,\n\t(select top 1 FieldValue from h where T<=@To order by T desc)  as F3\n\twhere @IncludeBeginEnd=1\n )\n\n\tselect CustomerID,DATEADD(hh, -9, T) AS Time,F1,F2,F3 from h3\n\tunion\n\tselect CustomerID,DATEADD(hh, -9, T) AS Time,F1,F2,F3 from h4\n\torder by Time\n\t\n\",\n\n\tProcess=[\n        SELECT(CustomerID,Time,F1,F2,F3)\n    ]\n)","ObjectType":18,"TimeStamp":"2019-12-19T07:49:34.09Z"}