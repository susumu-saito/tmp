{"Signature":"sv5Odn6HszmyeoLjGBFehw==","CustomerID":null,"QueryID":0,"QueryName":"test4_year","Description":"","CreationDate":"2019-12-20T05:20:29Z","PrefixedQueryName":"0.test4_year","Definition":"QueryDef(\n\tParameters=[\n\t\tCustomerID->Integer(Required=true),\n\t\tControllerID->Integer(Required=true),\n\t\tFrom->Date(Required=true, Period=\"Day\", EndOfPeriod=false),\n\t\tTo->Date(Required=true,Period=\"Day\",EndOfPeriod=true),\n\t\tFID1->Integer(_Match=\"FieldID\"),\n\t\tFID2->Integer(Required=false,_Match=\"FieldID\"),\n\t\tIncludeBeginEnd->Boolean(DESCription=\"With rows for report begin/end\",Required=true,Default=true)\n\t],\n\tInlinePars=PARS(CustomerID,ControllerID,FID1,FID2,IncludeBeginEnd),\n\tQuery=def(pars)=>$\"\n\n\tWITH h AS (\n\t\tSELECT\n\t\t\tDATEADD(hh, 9, Time) AS T,\n\t\t\tFieldID ,\n\t\t\tFieldValue\n\t\tFROM EventsHistory_{pars.ControllerID}\n\t\tWHERE FieldID IN (@FID1,@FID2)\n\t\t\tAND FieldValue IS NOT NULL\n\t),\n\n\th2 AS (\n\t\tSELECT @CustomerID AS CustomerID,\n\t\t\tT,\n\t\t\tDATEADD(DAY,DATEDIFF(DAY,0, getdate()),-365) as T1,\n\t\t\tDATEADD(DAY,DATEDIFF(DAY,0, getdate()),0) as T2,\n\t\t\t(CASE WHEN FieldID=@FID1 THEN FieldValue END) AS [F1],\n\t\t\t(CASE WHEN FieldID=@FID2 THEN FieldValue END) AS [F2]\n\t\t FROM h\n\t),\n\n\th3 AS (\n\t\tSELECT\n\t\t\tCustomerID,T,\n\t\t\tMAX(F1) AS FX1,\n\t\t\tMAX(F2) AS FX2\n                            \n\t\tFROM h2\n\t\twhere T between T1 and T2\n\t\tGROUP BY CustomerID,T\n\t),\n\n\th4 AS (\n\t\tSELECT\n\t\t\tCustomerID,\n\t\t\tDATEPART(YEAR, T) AS year,\n\t\t\tDATEPART(MONTH, T) AS month,\n\t\t\tSUM(FX1) AS FS1,\n\t\t\tSUM(FX2) AS FS2\n\n\t\tFROM h3\n\t\tGROUP BY\n\t\t\tCustomerID,\n\t\t\tDATEPART(YEAR, T),\n\t\t\tDATEPART(MONTH, T)\n\t),\n\n\th5 AS (\n\t\tSELECT\n\t\t\tCustomerID,\n\t\t\tyear,month,\n\t\t\tFS1,FS2,\n\t\t\tSUM(ROUND(FS1/(FS2/1000),2,1)) AS FS3\n\n\t\tFROM h4\n\t\tGROUP BY\n\t\t\tCustomerID,FS1,FS2,\n\t\t\tyear,\n\t\t\tmonth\n\t)\n\t , starth as (\n\t\tselect top(1) @CustomerID as CustomerID,@From as [Time],\n\t\t(select top 1 FieldValue from h where T<=@From and FieldID=@FID1 order by T desc)  as F1,\n\t\t(select top 1 FieldValue from h where T<=@From and FieldID=@FID2 order by T desc)  as F2,\n\t\t(select top 1 FieldValue from h where T<=@From order by T desc)  as F3\n\t\twhere @IncludeBeginEnd=1\n \t)\n\t , endh as (\n\t\tselect top(1) @CustomerID as CustomerID,@To as [Time],\n\t\t(select top 1 FieldValue from h where T<=@To and FieldID=@FID1 order by T desc)  as F1,\n\t\t(select top 1 FieldValue from h where T<=@To and FieldID=@FID2 order by T desc)  as F2,\n\t\t(select top 1 FieldValue from h where T<=@To order by T desc)  as F3\n\t\twhere @IncludeBeginEnd=1\n \t)\n\n\n\tselect CustomerID,DATEADD(hh, -9, datetimefromparts(year,month,0,0,0,0,0)) AS Time,FS1,FS2,FS3 from h5\n\n\n\torder by month\n\n\t\n\",\n\n\tProcess=[\n        SELECT(CustomerID,Time,FS1,FS2,FS3)\n    ]\n)","ObjectType":18,"TimeStamp":"2019-12-20T05:20:29.49Z"}